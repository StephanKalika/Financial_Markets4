---
title: 'Ценообразование опционов <br> "Количественные финансы" '
author: "Салихов Марсель (marcel.salikhov@gmail.com)"
date: "2017-12-06"
output:
  slidy_presentation:
    css: styles.css
    footer: НИУ ВШЭ. Салихов Марсель (marcel.salikhov@gmail.com)
    lib_dir: libs
    self_contained: no
---

## Цели лекции 

+ полныть основные принципы и логику ценообразования опционов
+ понять логику модели Блека-Шоулза-Мертона (BSM)
+ изучить имплементацию модели BSM в R
+ понять принципы расчета подразумеваемой волатильности и чувствительности опционов
+ понять принципы биноминальной модели ценообразования опционов и риск-нейтральные вероятности 




```{r setup, cache=FALSE, echo=FALSE, message=FALSE, warning=FALSE}

library("RColorBrewer")    # brewer.pal
library("knitr")           # opts_chunk
library(quantmod)


# color palette
palette(brewer.pal(6, "Set1"))

opts_chunk$set(fig.width=12, fig.height=7)
opts_chunk$set(cache = TRUE, fig.align="center", comment=NA, echo=TRUE, tidy=FALSE)

# преобразовать объект xts в dataframe с сохранением индекса даты
XtstoDf <- function(ts, ...){ 
  df <- as.data.frame(ts)
  df$date <- time(ts)
  return(df)
}
load('../.RData')
par(las=0)
```



## Постановка задачи

+ Предположим, что акция стоит сейчас 70 рублей. Завтра эта акция может стоить либо 100 рублей, либо 50 рублей. Как мы можем оценить стоимость опциона, который дает нам право купить 100 акций по цене 80 рублей завтра? 

+ Если завтра цена составит 100 рублей, то наша прибыль составит 2000 рублей  $=max[100-80;0] \cdot 100$. Если цена акции составляет 50 рублей, то мы не получаем ничего, так как **внутренняя стоимость** опциона равна нулю $=max[50-80;0] = 0$.

+ Модель BSM (Black-Scholes-Merton) основана на принципах **отсутствия арбитража**. Это означает, что если два актива имеют одинаковые денежные потоки, то они должны иметь одинаковую цену. К примеру, если мы сможем найти такой портфель акций и облигаций, которые реплицируют наш опцион, то стоимость этого портфеля должна быть цене опциона. 

## Постановка задачи - 2 

+ Вы купили 40 акций сегодня. Вы заплатите за эти акции $2800 = 70 \cdot 40$. Если завтра завтра цена вырастет до 100 рублей, то ваши акции будут стоить 4000 рублей (40 * 100). Прибыль по позиции будет равна 2000 рублей - то есть денежные потоки в этом случае будут одинаковы с опционом. 

+ С другой стороны, если цена составит 50 рублей, то стоимость портфеля составит 2000 рублей. Убыток составит -800 рублей. 

+ Таким образом, если арбитражных возможностей не существует, цена опциона составляет ...

> - 800 рублей (2800 - 2000 = 800), или 8 рублей на акцию. 

## Получение рыночных цен на опционы с помощью quantmod::getOptionChain

+ Пакет `quantmod` позволяет получить данные по опционам для эмитентов США в виде отдельной таблицы (option board). Источник данных: Yahoo Finance
+ С учетом того, что у опционов меняются страйки и даты экспирации, с каждой момент времени на одну акцию может быть доступно несколько тысяч опционных контрактов. 

Загрузим опционную доску на акции Amazon со сроком истечения 18 января 2018 года. 

```{r, warning=FALSE}
require(quantmod)
options <- getOptionChain("AMZN",Exp="2018-01-19")
head(options)
calls <- options$calls[,c(1:2,7)]
puts <- options$puts[,c(1:2,7)]
```

## Стоимость акций AMZN (Amazon)

```{r}
getSymbols("AMZN", src = "google")
chart_Series(AMZN['2017::'])
stock.price = as.numeric(last(AMZN)[,4])

```


## Внутренняя цена опциона (intrinsic value)

Внутренняя стоимость опциона  --  это та величина, которую мы получим исполнив опцион сейчас.  

для колл опциона 

$$IntrinsicValue = max[S_t - K, 0] $$ 
для опциона пут

$$IntrinsicValue = max[K - S_t, 0] $$ 

где $S_t$ -- текущая цена акции, $K$ -- страйк. 

внутренняя цена опциона составляет для нашего примера составляет:  

```{r}
calls$diff <- stock.price - calls$Strike
calls$dummy <- calls$diff < calls$Last
calls
```

До срока экспирации текущая цена опциона должна быть больше внутренней стоимости, так как всегда существует возможность, что цена опциона еще вырастет из-за того, что стоимость акции изменится. Если цена опциона меньше внутренней стоимости, то это означает проблемы с данными. В данном случае это связано, что последняя цена (Last price) была достаточно давно и не отражает реальные рыночные цены на текущий момент. 

Мы оставим только те контракты, которые имеют положительную внутреннюю стоимость

```{r}
calls = calls[calls$dummy,] # оставим только те значения, где dummy = TRUE
puts$diff <- puts$Strike-stock.price
puts$dummy <- puts$diff<puts$Last
puts = puts[puts$dummy,]
```

## Блек, Шоулз и Мертон




<div align="center">
  <img src="fig/merton-scholes-black.jpeg" width="640" height="250" />
</div>


## Формула BSM (Black-Scholes-Merton)

В модели BSM, стоимость опциона оценивается на цене портфеля акций и облигаций, которые реплицируют денежные потоки опциона. Привлекательность модели заключается в том, что это решение находится в закрытой форме. 

$$ Call = S \cdot N(d_1) + K exp (-rf \cdot T) N(d_2) $$
$$ Put = K exp (-rf \cdot T) N(-d_2) - S \cdot N(-d_1) $$
где

$$ d_1 = \frac{ln(S/K)+rf + 1/2 \cdot \sigma^2 \cdot T }{\sigma \cdot \sqrt{T} }$$
$$d_2 = d_1 - \sigma \cdot \sqrt{T} $$
$S$ -- цена акции, $K$ -- страйк, $T$ -- время до истечения опциона, $rf$ -- безрисковая ставка, $\sigma$ -- волатильность акции (базового актива), $N()$ -- кумулятивная функция стандартного нормального распределения. 

to recap: кумулятивная функция распределения (или просто "функция распределения") описывает вероятность того, что случайная переменная X примет какое-либо значение, не превышающее либо равное x.

## Допущения модели BSM 

1. **Постоянная волатильность**
2. **Эффективные рынки** -- модель предполагает, что изменение цены базового актива описывается случайным блужданием. 
3. **Отсутствие дивидендов** в классической формуле. 
4. **Фиксированная безрисковая ставка**
5. **Логнормальное распределение доходностей** базового актива
6. **Опцион европейского типа** -- исполнение толькко в дату экспирации 
7. **Отсутствие комиссий и транзакционных издержек**
8. **Идеальная ликвидность** 


## Иплементация модели BSM в R 

зададим некоторые вводные параметры 

```{r}
stock.price = 1159.11
expiry.date <- as.Date("2018-01-19")
value.date <- as.Date("2017-12-06")
TTM <- as.numeric((expiry.date - value.date)/365) # время до экспирации, лет
rf = 1.3/100 * TTM # безрисковая ставка 
```

Безрисковая ставка оценивается на основе 3-месячной ставка по казначейским векселям США. 

оценим историческую волатильность на основе данных за 2017 год

```{r}
volatility <- AMZN[,4]["2017::"] # цена закрытия 
volatility$ret <- diff(log(volatility$AMZN.Close)) # расчет лог-доходности 
hist.vol <- sd(volatility$ret, na.rm = TRUE)*sqrt(252) # стандартное отклонение, приведенный в "годовой"" формат
hist.vol
```

выберем для простоты только опционы со страйком 1150 и 1160 

```{r}
bs.calls <- calls[calls$Strike == 1150|calls$Strike == 1160,]
bs.calls
```

используем формулы BSM, чтобы оценить стоимость опциона:

```{r}
d1 <- (log(stock.price/bs.calls$Strike) + (rf+0.5*(hist.vol)^2)*TTM)/(hist.vol*sqrt(TTM))
cat("d1 = ",d1, "\n")
d2 <- d1 - hist.vol*sqrt(TTM)
cat("d2 = ",d2, "\n")

bs.calls$optval <- stock.price*pnorm(d1,mean = 0,sd = 1) - bs.calls$Strike*exp(-rf*TTM)*pnorm(d2,mean = 0,sd = 1)
bs.calls
```

Рыночные цены опционов несколько выше цен, которые мы получили в рамках модели BSM.

## Использование модели BSM для пут-опционов

```{r}
bs.puts = puts[puts$Strike == 1150|puts$Strike == 1160,]
bs.puts
bs.puts$optval <- bs.puts$Strike*+ exp(-rf*TTM)*pnorm(-d2,mean=0,sd=1) - stock.price*pnorm(-d1,mean=0,sd=1)
bs.puts
```

Цены пут-опционов в рамках BSM оказались гораздо ближе к рыночным ценам. 


## Функция для расчета BSM

запишем процедуру расчета модели BSM в виде отдельной функци 

```{r}
# функция расчета стоимости опциона по модели BSM 
bs.opm <- function(S, K, T, riskfree, sigma, type){
 d1<-(log(S/K)+(riskfree + 0.5*sigma^2)*T)/(sigma*sqrt(T))
 d2 <- d1-sigma*sqrt(T)
 if(type=="Call"){
   opt.val <- S*pnorm(d1) - K*exp(-riskfree*T)*pnorm(d2)
 }
 if(type=="Put"){
   opt.val <- K*exp(-riskfree*T)*pnorm(-d2) - S*pnorm(-d1)
 }
return(opt.val)
}

```

проверим процедуру расчета 

```{r}
bs.opm(stock.price,1150,TTM,rf,hist.vol,"Call")
bs.opm(stock.price,1160,TTM,rf,hist.vol,"Call")
bs.opm(stock.price,1150,TTM,rf,hist.vol,"Put")
bs.opm(stock.price,1160,TTM,rf,hist.vol,"Put")
```

результаты аналогичны


## Паритет опционов колл и пут

В рамках BSM, если мы знаем цену опциона колл(пут), то мы можем найти цену опциона пут (колл) с аналогичным страйком и временем до погашения используя формулу паритета.

$$ P+ S = С + K  exp(-rf \cdot T) $$
проверим, что паритет выполняется в нашем случае

```{r}
bs.calls$optval.pcparity <- bs.puts$optval-bs.puts$Strike*exp(-rf*TTM)+stock.price
bs.calls
```

для опционов пут 

```{r}
bs.puts$optval.pcparity<-bs.calls$optval+bs.puts$Strike*exp(-rf*TTM)-stock.price
bs.puts
```

Паритет выполняется в "мире" BSM. В рыночных ценах паритет может не выполняться

```{r}
bs.calls$Last.pcparity<-bs.puts$Last-bs.puts$Strike*exp(-rf*TTM)+stock.price
bs.calls
bs.puts$Last.pcparity<-bs.calls$Last+bs.puts$Strike*exp(-rf*TTM)-stock.price
bs.puts

```

Это связано с тем, что допущения BSM на практике могут не выполняться. 


## Чувствительность опциона к входным параметрам 

Когда оценивается стоимость опциона, мы заинтересованы в том, чтобы оценить чувствительность опциона ко входным параметрам. Эти чувствительности получили стандартные греческие буквы: 

+ $\delta$ ("Дельта") -- чувствительность к изменению цены базового актива
+ $\gamma$ ("Гамма") -- чувствительность к изменению Дельты, т.е. вторая производная цены
+ ("Вега") -- чувствительность к изменению волатильности базового актива
+ $\theta$ ("Тета") -- чувствительность к изменению срока до погашения
+ $\rho$ ("Ро") -- чувствительность к изменению безрисковой ставки 

В рамках модели BSM можно использовать стандартные формулы для оценки этих чувствительностей

```{r}
greeks.call <- bs.calls[,1:2]
greeks.call$delta <- pnorm(d1,mean=0,sd=1)
greeks.call$gamma <- dnorm(d1,mean=0,sd=1)/ (stock.price*hist.vol*sqrt(TTM))
greeks.call$vega <- stock.price*dnorm(d1,mean=0,sd=1)*sqrt(TTM)
greeks.call$theta <- -((stock.price*hist.vol*dnorm(d1,mean=0,sd=1))/(2*sqrt(TTM))) - (rf*greeks.call$Strike*exp(-rf*TTM)*pnorm(d2,mean=0,sd=1))
greeks.call$rho<- greeks.call$Strike*TTM*exp(-rf*TTM)*pnorm(d2,mean=0,sd=1)
greeks.call
```

для опционов пут

```{r}
greeks.put<- bs.puts[,1:2]
greeks.put$delta<- pnorm(d1,mean=0,sd=1)-1
greeks.put$gamma<- dnorm(d1,mean=0,sd=1)/ (stock.price*hist.vol*sqrt(TTM))
greeks.put$vega<- stock.price*dnorm(d1,mean=0,sd=1)*sqrt(TTM)
greeks.put$theta<--((stock.price*hist.vol*dnorm(d1,mean=0,sd=1))/(2*sqrt(TTM))) + (rf*greeks.put$Strike*exp(-rf*TTM)*pnorm(-d2,mean=0,sd=1))
greeks.put$rho<- -greeks.put$Strike*TTM*exp(-rf*TTM)*+ pnorm(-d2,mean=0,sd=1)
greeks.put
```


## Подразумеваемая волатильность (implied volatility)

+ Из пяти входных параметров BSM, **волатильность актива** не наблюдаема. Для инвесторов оценка волатильности исходя из рыночной цены опциона дает представлением о том, что рынок "думает" о волатильности и как она изменяется со временем. 
+ Определение подразуемовой волатильности осщуществляется численными методами. Для простоты мы будем использовать простой **метод бисекции** для поиска IV. Мы используем начальное значение для волатильности (историческая волатильность) и оцениваем стоимость опциона по формуле BSM. Если разница между нашей оценкой и рыночной ценой больше по модулю заданного $\epsilon$, то используем новое значение волатильности, которое представляет собой половину предыдущего значения + либо - некоторое значение сигма. Мы также ставим ограниччение максимум в 1000 итераций. Если мы не смогли найти значение IV с точностью $\epsilon$ за 1000 итераций, то функция возвращает `NA`. 


```{r}
# функция поиска значений подразумеваемой волатильности методом бисекции 
iv.opt<- function(S,K,T,riskfree,price,type){
  sigma <- hist.vol
  sigma.up <- 1
  sigma.down<- 0.001
  count<- 0
  epsilon <- bs.opm(S,K,TTM,riskfree,sigma,type)- price
  while(abs(epsilon)>0.00001 & count<1000){
     if(epsilon<0){
         sigma.down < -sigma
         sigma <- (sigma.up + sigma)/ 2
       } else{
    sigma.up<- sigma
    sigma<- (sigma.down+sigma)/ 2
  }
 epsilon<- bs.opm(S,K,TTM,riskfree,sigma,type)-price
 count<- count+1
 }
  if(count==1000){
  return(NA)
 } else{
  return(sigma)
 }
}
```

используем расчет для нашего примера 

```{r}
iv.opt(stock.price,1150,TTM,rf,37.25,"Call")
hist.vol
```
Подразумевамая волатильность равна 22,5%, историческая -- 21%. 

## Улыбка волатильности (volatility smile)

посчитаем подразумеваемую волатильность для разных страйков

```{r, cache=TRUE}
calls$iv = NA
for(i in 1:nrow(calls)){
   #cat(i,'\n')
   calls$iv[i] = iv.opt(stock.price, calls$Strike[i], TTM, rf, calls$Last[i], "Call")
}

```

построим график IV в зависимости от страйка

```{r}
require(ggplot2)
p = ggplot(data = calls, aes(x=Strike, y = iv*100))
p = p + geom_point()+theme_minimal()+xlab('Страйк, $')+ylab("Подразумевая волатильность, %")+
   ggtitle(paste0("Подразумевамая волатильность колл-опционов AMZN c погашением ", expiry.date))
p+ geom_vline(xintercept=stock.price, color = 'red')+ geom_text(aes(x=stock.price+30, label="Текущая цена акции", y=50), colour="red", angle=90)
```


Следствие из BSM -- волатильность опционов должна быть одинаковой на всех страйках. Очевидно, что это не так. Рынок оценивает волатильность по разному на разных страйках. 

Количество открытых позиций на определенных стайках значительно больше соседних значений -- это целые значения стайков. 

```{r}
p = ggplot(data = calls, aes(x=Strike, y = OI))
p = p + geom_bar(stat = 'identity')+theme_minimal()+xlab('Страйк, $')+ylab("OI, отктытых контрактов")
p+ geom_vline(xintercept=stock.price, color = 'red')+ geom_text(aes(x=stock.price+30, label="Текущая цена акции", y=1000), colour="red", angle=90)

```

## Биномиальная модель ценообразования опционов

+ Большинство опционов на практике не могут быть решены закрытым образом в рамках модели BSM. Различные численные методы используются в этом случае. 

+ Эти методы могут быть достаточно сложными. Мы рассмотрим простой случай на основе **биномиальной модели**, которая дает представление, как работают эти методы. 

+ **Биномиальная модель** -- древообразная модель, которая позволяет нам задавать изменение цены базового актива дискретными шагам. 


## Иллюстация биномиальной модели 

Представим, что цена акции сегодня равна $V$. В биномиальной модели значение акции через 6 месяцев может быть либо быть выше на $u$, либо ниже на $d$. Таким образом, через 6 месяцев значение цены акции можеть быть либо $Vd$, либо $Vu$. В конце года (через 12 месяцев), значение может либо $Vuu$, либо $Vud=Vdu$, либо $Vdd$. 

<div align="center">
  <img src="fig/binomial.png" width="608" height="396" />
</div>


## Риск-нейтральная вероятность

**Риск-нейтральная вероятность** $p$ определяет вероятность того, что цена акции пойдет вверх. Значит, вероятность того, что акция пойдет вниз равна $1-p$. 

Вернемся к нашему примеру с опционом  на AMZN, в котором цена акции = 1159, страйк = 1150, время до истечения равно = 0,12 лет, историческая волатильность равна 21%. Предполжим, что безрисковая ставка равна 1,3% в год. Какова стоимость такого опциона в рамках биномиальной модели?

Рассчитаем значение фактора $u$ как 

$$ u = exp(\sigma \cdot \sqrt{dt}) = 1.053037 $$
где $dt$ определяет временной интервал каждого шага, то есть (TTM/2), если мы берем случай двух шагов. 

Величина $d = 1/u = 0.9496342$

Если цена акции равна 1159, то в конце первого шага она может быть равно либо 1.053037 * 1159 = 1220.47, либо 1100.63 = 0.9496342. В конце второго шага есть следующие три варианта: 1285.2, 1159.0, 1045.2

Тогда $p$ -- риск-нейтральную вероятность  того, что цена пойдет вверх, можно рассчитать как: 

$$p = \frac{((1 + rf \cdot dt)) - d}{u-d} = \frac{(1+ 0.0007 \cdot 0.06)-0.9496342}{1.053037-0.9496342} = 0.4875$$

тогда $1-p=0.5125$ 

## Расчет стоимости опциона в рамках биномильной модели 


<div align="center">
  <img src="fig/binom-example.png" width="642" height="602" />
</div>

## Имплементация биномиальной модели расчета в R

```{r}
 EuroCRR <- function(S,K,T,r,sigma,n,type){
   x =  NA
   if (type=="call") x=1
   if (type=="put") x=-1
   if(is.na(x)) stop("Option Type can only be call or put")
   dt = T/n
   u = exp(sigma*sqrt(dt))
   d = 1/u
   p = ((1 + r * dt)- d)/(u-d)
   disc = 1 + r * dt
   OptVal = x * (S*u^(0:n)*d^(n:0)-K)
   OptVal = ifelse(OptVal<0, 0, OptVal)
   for(j in seq(from = n-1, to = 0, by = -1))
      for(i in 0:j)
         OptVal[i+1] = (p*OptVal[i+2] + (1-p)*OptVal[i+1])/disc
   value=OptVal[1]
   results <- rbind(u,d,p,value)
   results 
 }  

```

рассчитаем стоимость нашего опциона со страйком 1159 с двумя шагами 

```{r}
EuroCRR(1159,1150,TTM,0.0007,hist.vol,2,"call")
```

если мы увеличим количество шагов, то получим постепенное приближение к модели BSM 

```{r}
EuroCRR(1159,1150,TTM,0.0007,hist.vol,100,"call")
```

## Cписок использованных источников 

1. Black, F., & Scholes, M. (1973). Pricing of options and corporate liabilities. The Journal of
Political Economy, 81, 637–654.
2. Hull, J. (2011). Options, futures, and other derivatives (8th ed.). Prentice Hall.
3. Wilmott, P. (2007). Paul Wilmott introduces quantitative ﬁnance (2nd ed.). New Jersey: Wiley. 
4. Ang, C. (2015). "Analyzing Financial Data and Implementing Financial Models". Springer.